name: Keep Render App Alive + Alert

on:
  schedule:
    - cron: "* * * * *"   # every 1 minute
  workflow_dispatch:

jobs:
  keepalive:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Restore last status from cache
      - name: Restore last status
        uses: actions/cache@v4
        with:
          path: last_status.txt
          key: render-status

      # 2ï¸âƒ£ Check Render health
      - name: Check Render Health
        id: check
        run: |
          URL="https://website-evilkernel.onrender.com/health"
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 $URL || echo "000")
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "HTTP STATUS: $STATUS"

      # 3ï¸âƒ£ Read previous status
      - name: Read previous status
        id: prev
        run: |
          if [ -f last_status.txt ]; then
            PREV=$(cat last_status.txt)
          else
            PREV="UNKNOWN"
          fi
          echo "prev=$PREV" >> $GITHUB_OUTPUT
          echo "Previous status: $PREV"

      # 4ï¸âƒ£ Save current status
      - name: Save current status
        run: |
          echo "${{ steps.check.outputs.status }}" > last_status.txt

      # 5ï¸âƒ£ Send DOWN alert
      - name: Send DOWN alert
        if: steps.check.outputs.status != '200'
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="ðŸš¨ ALERT: Render app is DOWN (status ${{ steps.check.outputs.status }})"

      # 6ï¸âƒ£ Send RECOVERY alert
      - name: Send RECOVERY alert
        if: steps.prev.outputs.prev != '200' && steps.check.outputs.status == '200'
        env:
          BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          curl -s -X POST https://api.telegram.org/bot$BOT_TOKEN/sendMessage \
            -d chat_id=$CHAT_ID \
            -d text="âœ… RECOVERY: Render app is back ONLINE"

      # 7ï¸âƒ£ Keep Render awake (15s pings)
      - name: Keep Render Awake
        run: |
          URL="https://website-evilkernel.onrender.com/health"
          for i in {1..4}; do
            curl -s $URL > /dev/null
            sleep 15
          done
